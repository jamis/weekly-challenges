DATA = {
  name: "Frederick Warner Causey",
  father: {
    name: "Melvyn Justice Causey",
    father: {
      name: "Eddie Garret Causey",
      father: {
        name: "Robert Marcus Causey",
        father: {
          name: "Daniel Horace Causey",
          father: {
            name: "Orson Dee Causey",
            father: { name: "Dolph Harland Causey" },
            mother: { name: "Fay Ursula Royce" }
          },
          mother: {
            name: "Jayne Sherrie Oakley",
            father: { name: "Alvin Marshal Oakley" },
            mother: { name: "Felicity Meghan Merchant" }
          }
        },
        mother: {
          name: "Janis ZoÃ« Groves",
          father: {
            name: "Walker Brent Groves",
            father: { name: "Alf Archer Groves" },
            mother: { name: "Trisha Marilyn Law" }
          },
          mother: {
            name: "Mattie Prudence Jeffers",
            father: { name: "Hank Melville Jeffers" },
            mother: { name: "Pansy Velma Randall" }
          }
        }
      },
      mother: {
        name: "Margo Quinn Hawking",
        father: {
          name: "Irvine Kennedy Hawking",
          father: {
            name: "Miles Hampton Hawking",
            father: { name: "Wilson Garth Hawking" },
            mother: { name: "Audie Madlyn Edison" }
          },
          mother: {
            name: "Sal Anita Abbott",
            father: { name: "Cassius Rod Abbott" },
            mother: { name: "Lillian Adria Nigel" }
          }
        },
        mother: {
          name: "Kathanryn Jacquelyn Rayne",
          father: {
            name: "Hugh Avery Rayne",
            father: { name: "Elmer Herbie Rayne" },
            mother: { name: "Sallie Florrie Danell" }
          },
          mother: {
            name: "Courtney Katharyn Rogers",
            father: { name: "Robbie Bennett Rogers" },
            mother: { name: "Emery Anastasia Kemp" }
          }
        }
      }
    },
    mother: {
      name: "Hale Maud Avery",
      father: {
        name: "Archie Fredrick Avery",
        father: {
          name: "Lanford Cherokee Avery",
          father: {
            name: "Jez Randolf Avery",
            father: { name: "Victor Timothy Avery" },
            mother: { name: "Imogene Maudie Watts" }
          },
          mother: {
            name: "Carlene Hildred Patton",
            father: { name: "Ben Riley Patton" },
            mother: { name: "Alisha Pen Stanford" }
          }
        },
        mother: {
          name: "Norene Charlie Levitt",
          father: {
            name: "Holden Lee Levitt",
            father: { name: "Trev Marshal Levitt" },
            mother: { name: "Lexi Emily Hawking" }
          },
          mother: {
            name: "Halle April Blackbourne",
            father: { name: "Matt Thom Blackbourne" },
            mother: { name: "Freddie Narelle Wilkerson" }
          }
        }
      },
      mother: {
        name: "Rachel Sierra Brigham",
        father: {
          name: "Leroy Adolph Brigham",
          father: {
            name: "Carson Kevyn Brigham",
            father: { name: "Ozzie Val Brigham" },
            mother: { name: "Lettie Alvena Barber" }
          },
          mother: {
            name: "Vivyan Ernestine Clark",
            father: { name: "Lindsey Charlie Clark" },
            mother: { name: "Murphy Angie Milburn" }
          }
        },
        mother: {
          name: "Jaylen Lexus Nicolson",
          father: {
            name: "Myles Delmar Nicolson",
            father: { name: "Davey Brock Nicolson" },
            mother: { name: "Kristina Lauren Curtis" }
          },
          mother: {
            name: "Bethany Cecelia Rennold",
            father: { name: "Wilburn Connie Rennold" },
            mother: { name: "Roseann Esther Ellsworth" }
          }
        }
      }
    }
  },
  mother: {
    name: "Lawrie Justina Shakesheave",
    father: {
      name: "Scot Tyler Shakesheave",
      father: {
        name: "Herman Finlay Shakesheave",
        father: {
          name: "Walter Beverly Shakesheave",
          father: {
            name: "Clark Jeremiah Shakesheave",
            father: { name: "Dwain Jamie Shakesheave" },
            mother: { name: "Dell Aileen Darwin" }
          },
          mother: {
            name: "Livvy Bee Sharrow",
            father: { name: "Mo Des Sharrow" },
            mother: { name: "Anastasia Shana Ingram" }
          }
        },
        mother: {
          name: "Harley Della Gilliam",
          father: {
            name: "Vern Moses Gilliam",
            father: { name: "Bradford Cedric Gilliam" },
            mother: { name: "Chrissie Sadie Burton" }
          },
          mother: {
            name: "Leanna Babs Paris",
            father: { name: "Sammie Teddy Paris" },
            mother: { name: "Hatty Chantal Roberts" }
          }
        }
      },
      mother: {
        name: "Lenora Berry Kingston",
        father: {
          name: "Chance Milburn Kingston",
          father: {
            name: "Will Milton Kingston",
            father: { name: "Nik Mackenzie Kingston" },
            mother: { name: "Callie Andrea Elwyn" }
          },
          mother: {
            name: "Maggie Carina Colbert",
            father: { name: "Cyrus Kenny Colbert" },
            mother: { name: "Adrianne Carlie Reynolds" }
          }
        },
        mother: {
          name: "Yvonne Barbara Peters",
          father: {
            name: "Lucian Max Peters",
            father: { name: "Trenton Ern Peters" },
            mother: { name: "Nat Sharyl Greene" }
          },
          mother: {
            name: "Brandy Paige Kevins",
            father: { name: "Edmond Mitch Kevins" },
            mother: { name: "Abbey Kira Little" }
          }
        }
      }
    },
    mother: {
      name: "Shari Evie Burnham",
      father: {
        name: "Sebastian Daniel Burnham",
        father: {
          name: "Randolph Algernon Burnham",
          father: {
            name: "Hector Myles Burnham",
            father: { name: "Benji Quentin Burnham" },
            mother: { name: "Wilma Cassie Tailor" }
          },
          mother: {
            name: "Bonita Hariette Beck",
            father: { name: "Benjy Everette Beck" },
            mother: { name: "Drea Mabel Gibson" }
          }
        },
        mother: {
          name: "Kimberly Violet Lund",
          father: {
            name: "Andre Kirby Lund",
            father: { name: "Haven Eliot Lund" },
            mother: { name: "Kelli Rosanna Alberts" }
          },
          mother: {
            name: "Dinah Barney Thorley",
            father: { name: "Bryce Randal Thorley" },
            mother: { name: "Bunny Barbra Wyndham" }
          }
        }
      },
      mother: {
        name: "Anastasia Heidi Frost",
        father: {
          name: "Hardy Kurt Frost",
          father: {
            name: "Norton Tanner Frost",
            father: { name: "Harris Ariel Frost" },
            mother: { name: "Delora Jade Riley" }
          },
          mother: {
            name: "Dixie Myrtle Gardyner",
            father: { name: "Quincy Van Gardyner" },
            mother: { name: "Lillia Kitty Wallis" }
          }
        },
        mother: {
          name: "Hillary Eve Rose",
          father: {
            name: "Noel Rolf Rose",
            father: { name: "Jude Marcus Rose" },
            mother: { name: "Delia Suzi Bush" }
          },
          mother: {
            name: "Trixie Audley Maynard",
            father: { name: "Neely Sal Maynard" },
            mother: { name: "Georgina Renae Preston" }
          }
        }
      }
    }
  }
}

require 'prawn'

def generations(node, max=4, accumulator=[], n=0)
  return if n+1 > max

  node ||= {}
  accumulator[n] ||= []

  accumulator[n] << node[:name]

  generations(node[:father], max, accumulator, n+1)
  generations(node[:mother], max, accumulator, n+1)

  accumulator
end

def pedigree(generations)
  opts = { page_size: "LETTER",
           page_layout: :landscape,
           margin: 18 }

  Prawn::Document.generate("pedigree.pdf", opts) do |pdf|
    pdf.font "Helvetica"

    width = pdf.margin_box.width
    height = pdf.margin_box.height
    middle = height / 2

    generation_width = width / generations.length
    preferred_font_size = choose_best_font_size(pdf, generation_width, generations)

    pdf.font "Helvetica", size: preferred_font_size
    box_height = pdf.height_of("Tj")

    pdf.line_width 0.5
    pdf.cap_style :round

    list = generations.last
    y_gap = (height - list.length * box_height) / (list.length + 1)
    y_offsets = list.length.times.map { |i| height - (y_gap * (i+1) + box_height * i) }

    generations.reverse.each.with_index do |list, n|
      x = width - (n+1) * generation_width

      list.each.with_index do |name, i|
        y = y_offsets[i]
        pdf.text_box(name, at: [x + preferred_font_size/2, y], width: width)

        y -= pdf.font.ascender + 1
        pdf.line [x, y], [x+generation_width, y]

        if i % 2 == 1 then
          yp = y_offsets[i-1] - pdf.font.ascender - 1
          pdf.line [x, y], [x, yp]
        end
      end

      pdf.stroke

      next if list.length < 2

      next_offsets = []
      y_offsets.each_slice(2) do |father, mother|
        next_offsets << father + (mother + box_height - father) / 2
      end

      y_offsets = next_offsets
    end
  end
end

def choose_best_font_size(pdf, max_width, generations)
  size = 12.0
  names = generations.flatten

  names.each do |name|
    loop do
      width = pdf.width_of(name, size: size) + size
      break if width <= max_width
      size -= 0.25
    end
  end

  size
end

list = generations(DATA, 7)
pedigree(list)
